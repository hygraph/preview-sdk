!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).HygraphPreviewSDK={})}(this,function(e){"use strict";class t{constructor(e){this.registry={},this.observer=null,this.isDestroyed=!1,this.config=e,this.initializeObserver(),this.scanExistingElements()}getElementsForField(e,t){const i=[];for(const n of Object.values(this.registry))for(const r of n)r.fieldApiId===e&&r.locale===t&&i.push(r);return i}getElementsForEntryField(e,t,i){const n=[];for(const r of Object.values(this.registry))for(const o of r)o.entryId===e&&o.fieldApiId===t&&o.locale===i&&n.push(o);return n}getElementsForEntry(e){const t=[];for(const i of Object.values(this.registry))for(const n of i)n.entryId===e&&t.push(n);return t}getElement(e,t,i){const n=this.createRegistryKey(e,t,i),r=this.registry[n];return(null==r?void 0:r[0])||null}refresh(){this.isDestroyed||this.scanExistingElements()}destroy(){var e;this.isDestroyed=!0,null==(e=this.observer)||e.disconnect(),this.registry={}}initializeObserver(){this.observer=new MutationObserver(e=>{var t;if(!this.isDestroyed)for(const i of e){if("childList"===i.type)for(const e of i.addedNodes)e.nodeType===Node.ELEMENT_NODE&&this.scanElement(e);"attributes"===i.type&&(null==(t=i.attributeName)?void 0:t.startsWith("data-hygraph-"))&&this.updateElementRegistration(i.target)}}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-hygraph-entry-id","data-hygraph-field-api-id","data-hygraph-field-locale","data-hygraph-component-chain"]})}scanExistingElements(){document.querySelectorAll("[data-hygraph-entry-id]").forEach(e=>this.scanElement(e))}scanElement(e){this.hasHygraphAttributes(e)&&this.registerElement(e);e.querySelectorAll("[data-hygraph-entry-id]").forEach(e=>this.registerElement(e))}hasHygraphAttributes(e){return e.hasAttribute("data-hygraph-entry-id")}registerElement(e){const t=e.getAttribute("data-hygraph-entry-id");if(!t)return;const i=e.getAttribute("data-hygraph-field-api-id")||void 0,n=e.getAttribute("data-hygraph-field-locale")||void 0,r=e.getAttribute("data-hygraph-component-chain")||void 0,o={element:e,entryId:t,fieldApiId:i,locale:n,componentChainRaw:r,lastUpdated:Date.now()},s=this.createRegistryKey(t,i,n);this.registry[s]||(this.registry[s]=[]);const a=this.registry[s].findIndex(t=>t.element===e);a>=0?this.registry[s][a]=o:this.registry[s].push(o),this.config.debug&&console.log("[FieldRegistry] Registered element:",{entryId:t,fieldApiId:i,locale:n,element:e.tagName})}updateElementRegistration(e){this.unregisterElement(e),this.hasHygraphAttributes(e)&&this.registerElement(e)}unregisterElement(e){for(const[t,i]of Object.entries(this.registry)){const n=i.filter(t=>t.element!==e);0===n.length?delete this.registry[t]:this.registry[t]=n}}createRegistryKey(e,t,i){const n=[e];return t&&n.push(t),i&&n.push(i),n.join(":")}getStats(){const e=new Set,t=new Set;let i=0;for(const n of Object.values(this.registry)){i+=n.length;for(const i of n)e.add(i.entryId),i.fieldApiId&&t.add(`${i.entryId}:${i.fieldApiId}`)}return{totalElements:i,entriesCount:e.size,fieldsCount:t.size}}getRegistryKeys(){return Object.keys(this.registry)}}class i{constructor(e){this.isConnected=!1,this.studioOrigin=null,this.messageQueue=[],this.isDestroyed=!1,this.handleMessage=e=>{if(this.isDestroyed)return;if(!this.isOriginAllowed(e.origin))return void(this.config.debug&&console.log("[MessageBridge] Ignored message from disallowed origin:",e.origin));const t=e.data;this.isValidStudioMessage(t)?(this.config.debug&&console.log("[MessageBridge] Received message:",t),"init"===t.type&&this.handleConnection(e.origin),this.config.onMessage(t)):this.config.debug&&console.log("[MessageBridge] Ignored invalid message:",t)},this.config=e,this.setupMessageListener()}sendMessage(e){if(this.isDestroyed)return!1;if(!this.isConnected||!this.studioOrigin)return this.messageQueue.push(e),!1;try{return window.parent.postMessage(e,this.studioOrigin),this.config.debug&&console.log("[MessageBridge] Sent message:",e),!0}catch(t){return console.error("[MessageBridge] Failed to send message:",t),!1}}sendReadyMessage(e){if(this.isDestroyed)return!1;let t=!1;for(const n of this.config.allowedOrigins)try{window.parent.postMessage(e,n),this.config.debug&&console.log("[MessageBridge] Sent ready message to origin:",n,"message:",e),t=!0}catch(i){this.config.debug&&console.log("[MessageBridge] Failed to send ready message to origin:",n,"error:",i)}return t}isConnectedToStudio(){return this.isConnected}getStudioOrigin(){return this.studioOrigin}destroy(){this.isDestroyed=!0,this.isConnected=!1,this.studioOrigin=null,this.messageQueue=[],window.removeEventListener("message",this.handleMessage)}setupMessageListener(){this.config.debug&&console.log("[MessageBridge] Setting up message listener, allowed origins:",this.config.allowedOrigins),window.addEventListener("message",this.handleMessage),this.config.onReady&&setTimeout(()=>{this.config.onReady()},0)}isOriginAllowed(e){return this.config.allowedOrigins.includes(e)||this.config.allowedOrigins.some(t=>{if(t.includes("*")){const i=t.replace(/\*/g,".*");return new RegExp(`^${i}$`).test(e)}return!1})}isValidStudioMessage(e){if("object"!=typeof e||null===e)return!1;const t=e;if("string"!=typeof t.type)return!1;if("number"!=typeof t.timestamp)return!1;switch(t.type){case"init":return"string"==typeof t.studioOrigin;case"field-update":return"string"==typeof t.entryId&&"string"==typeof t.fieldApiId&&"string"==typeof t.fieldType&&void 0!==t.newValue;case"field-focus":return"string"==typeof t.entryId&&"string"==typeof t.fieldApiId;case"content-saved":return"string"==typeof t.entryId;case"disconnect":return!0;default:return!1}}handleConnection(e){this.isConnected||(this.isConnected=!0,this.studioOrigin=e,this.config.debug&&console.log("[MessageBridge] Connected to Studio:",e),this.flushMessageQueue())}flushMessageQueue(){const e=[...this.messageQueue];this.messageQueue=[];for(const t of e)this.sendMessage(t);this.config.debug&&e.length>0&&console.log(`[MessageBridge] Sent ${e.length} queued messages`)}}class n{constructor(e){this.updateQueue=new Map,this.isDestroyed=!1,this.config=e}async updateField(e){if(this.isDestroyed)return{success:!1,error:"ContentUpdater is destroyed"};try{const i=`${e.entryId}:${e.fieldApiId}:${e.locale||""}`;this.updateQueue.set(i,e),await this.delay(this.config.updateDelay||50);if(this.updateQueue.get(i)!==e)return{success:!0};this.updateQueue.delete(i);const n=this.findElements(e.entryId,e.fieldApiId,e.locale);if(0===n.length)return{success:!1,error:"No matching elements found"};let r=!1,o="";for(const s of n)try{await this.updateElement(s,e)}catch(t){r=!0,o=t instanceof Error?t.message:String(t),console.error("[ContentUpdater] Failed to update element:",t)}return r?{success:!1,error:o}:(this.config.debug&&console.log("[ContentUpdater] Updated field:",{entryId:e.entryId,fieldApiId:e.fieldApiId,locale:e.locale,elementsCount:n.length}),{success:!0,element:n[0]})}catch(t){const e=t instanceof Error?t.message:String(t);return console.error("[ContentUpdater] Update failed:",t),{success:!1,error:e}}}destroy(){this.isDestroyed=!0,this.updateQueue.clear()}findElements(e,t,i){const n=[];let r=`[data-hygraph-entry-id="${e}"]`;t&&(r+=`[data-hygraph-field-api-id="${t}"]`),i&&(r+=`[data-hygraph-field-locale="${i}"]`);const o=document.querySelectorAll(r);return n.push(...Array.from(o)),n}async updateElement(e,t){switch(t.fieldType){case"STRING":case"ID":case"ENUMERATION":this.updateTextField(e,t.newValue);break;case"RICHTEXT":await this.updateRichTextField(e,t.newValue);break;case"INT":case"FLOAT":this.updateNumberField(e,t.newValue);break;case"BOOLEAN":this.updateBooleanField(e,t.newValue);break;case"DATETIME":case"DATE":this.updateDateField(e,t.newValue);break;case"ASSET":await this.updateAssetField(e,t.newValue);break;case"LOCATION":this.updateLocationField(e,t.newValue);break;case"COLOR":this.updateColorField(e,t.newValue);break;case"COMPONENT":await this.updateComponentField(e,t.newValue);break;case"JSON":this.updateJsonField(e,t.newValue);break;case"RELATION":this.updateRelationField(e,t.newValue);break;default:throw new Error("Unsupported field type")}}updateTextField(e,t){(t||""===t)&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value=t:e.textContent=t)}async updateRichTextField(e,t){var i;try{let n;if("string"==typeof t)return n=t,void(this.shouldUseInnerHTML(e,n)?e.innerHTML=n:e.textContent=n);if(t&&"object"==typeof t)if("html"in t&&"markdown"in t){const r=e.getAttribute("data-hygraph-rich-text-format");if(this.config.debug&&console.log("[ContentUpdater] Rich Text multi-format update:",{formatPreference:r,availableFormats:Object.keys(t)}),"html"===r&&t.html)if(n=t.html,this.hasMorphdom()){const t=document.createElement(e.tagName);t.innerHTML=n,null==(i=window.morphdom)||i.call(window,e,t)}else e.innerHTML=n;else"markdown"===r&&t.markdown?(n=t.markdown,e.textContent=n):"text"===r&&t.text?(n=t.text,e.textContent=n):(n=t.html||this.richTextToHTML(t.ast||t),e.innerHTML=n)}else"children"in t&&(n=this.richTextToHTML(t),e.innerHTML=n)}catch(n){throw console.error("[ContentUpdater] Rich text update failed:",n),n}}updateNumberField(e,t){if(null==t)return;const i=String(t);"INPUT"===e.tagName?e.value=i:e.textContent=i}updateBooleanField(e,t){"INPUT"===e.tagName&&"checkbox"===e.type?e.checked=t:e.textContent=String(t)}updateDateField(e,t){if(!t)return;const i=new Date(t).toLocaleDateString();"INPUT"===e.tagName&&"date"===e.type?e.value=t.split("T")[0]:e.textContent=i}async updateAssetField(e,t){t&&(Array.isArray(t)?t.length>0&&await this.updateSingleAsset(e,t[0]):await this.updateSingleAsset(e,t))}async updateSingleAsset(e,t){if("IMG"===e.tagName){const i=e;i.src=t.url,t.alt&&(i.alt=t.alt),t.width&&(i.width=t.width),t.height&&(i.height=t.height)}else if("VIDEO"===e.tagName){e.src=t.url}else if("AUDIO"===e.tagName){e.src=t.url}else if("A"===e.tagName){const i=e;i.href=t.url,i.textContent||(i.textContent=t.fileName)}else e.innerHTML=`<img src="${t.url}" alt="${t.alt||""}" />`}updateLocationField(e,t){if(!t||"number"!=typeof t.latitude||"number"!=typeof t.longitude)return;const i=`${t.latitude}, ${t.longitude}`;e.textContent=i,e.setAttribute("data-latitude",String(t.latitude)),e.setAttribute("data-longitude",String(t.longitude))}updateColorField(e,t){t&&(e.textContent=t,e.style&&(e.style.backgroundColor=t))}async updateComponentField(e,t){var i;if(t)try{const n=this.renderComponent(t);if(this.hasMorphdom()){const t=document.createElement(e.tagName);t.innerHTML=n,null==(i=window.morphdom)||i.call(window,e,t)}else e.innerHTML=n}catch(n){throw console.error("[ContentUpdater] Component update failed:",n),n}}updateJsonField(e,t){if(null==t)return;const i=JSON.stringify(t,null,2);e.textContent=i}updateRelationField(e,t){null!==t?Array.isArray(t)?e.textContent=t.join(", "):e.textContent=t:e.textContent=""}richTextToHTML(e){return e.children?e.children.map(e=>this.renderRichTextNode(e)).join(""):""}renderRichTextNode(e){if("string"==typeof e.text)return this.escapeHtml(e.text);const t=Array.isArray(e.children)?e.children.map(e=>this.renderRichTextNode(e)).join(""):"";switch(e.type){case"paragraph":return`<p>${t}</p>`;case"heading-one":return`<h1>${t}</h1>`;case"heading-two":return`<h2>${t}</h2>`;case"heading-three":return`<h3>${t}</h3>`;case"heading-four":return`<h4>${t}</h4>`;case"heading-five":return`<h5>${t}</h5>`;case"heading-six":return`<h6>${t}</h6>`;case"block-quote":return`<blockquote>${t}</blockquote>`;case"bulleted-list":return`<ul>${t}</ul>`;case"numbered-list":return`<ol>${t}</ol>`;case"list-item":return`<li>${t}</li>`;case"link":return`<a href="${"string"==typeof e.href?e.href:""}">${t}</a>`;case"bold":return`<strong>${t}</strong>`;case"italic":return`<em>${t}</em>`;case"underline":return`<u>${t}</u>`;case"code":return`<code>${t}</code>`;default:return t}}renderComponent(e){return`<div data-component="${e.__typename}">${Object.entries(e).filter(([e])=>"__typename"!==e&&"id"!==e).map(([e,t])=>`<div data-field="${e}">${this.escapeHtml(this.formatComponentValue(t))}</div>`).join("")}</div>`}formatComponentValue(e){if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e||"boolean"==typeof e)return String(e);try{return JSON.stringify(e)}catch{return String(e)}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hasMorphdom(){return"function"==typeof window.morphdom}shouldUseInnerHTML(e,t){return!(!t.includes("<")||!t.includes(">"))}delay(e){return new Promise(t=>setTimeout(t,e))}}class r{constructor(e){this.overlayElement=null,this.editButtonElement=null,this.currentTarget=null,this.isDestroyed=!1,this.hoverTimeout=null,this.handleMouseMove=e=>{var t;if(this.isDestroyed)return;const i=e.target;if(i===this.editButtonElement||(null==(t=this.editButtonElement)?void 0:t.contains(i)))return;const n=i.closest("[data-hygraph-entry-id]");if(n&&n!==this.currentTarget){this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null);const e=n.getAttribute("data-hygraph-entry-id"),t=n.getAttribute("data-hygraph-field-api-id"),i=n.getAttribute("data-hygraph-field-locale");if(e){const r={element:n,entryId:e,fieldApiId:t||void 0,locale:i||void 0};this.showOverlay(n,r)}}else!n&&this.currentTarget&&(this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),setTimeout(()=>{this.currentTarget&&!this.isMouseOverEditButton(e)&&this.hideOverlay()},50))},this.handleMouseLeave=()=>{this.hideOverlay()},this.handleScroll=()=>{this.currentTarget&&this.updateOverlayPosition(this.currentTarget)},this.handleResize=()=>{this.currentTarget&&this.updateOverlayPosition(this.currentTarget)},this.config=e,this.createOverlayElements(),this.setupEventListeners()}showOverlay(e,t){!this.isDestroyed&&this.config.overlayEnabled&&(this.currentTarget=e,this.updateOverlayPosition(e),this.updateEditButton(t),this.showOverlayElements())}hideOverlay(){this.isDestroyed||(this.currentTarget=null,this.hideOverlayElements())}destroy(){this.isDestroyed=!0,this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.removeOverlayElements(),this.removeEventListeners()}createOverlayElements(){var e,t;const i=(null==(e=this.config.overlay)?void 0:e.style)||{},n=i.borderColor||"#3B82F6",r=i.borderWidth||"2px",o=i.backgroundColor||"rgba(59, 130, 246, 0.1)",s=void 0!==i.opacity?i.opacity:1,a=i.borderRadius||"4px";this.config.debug&&console.log("[OverlayManager] Creating overlay with config:",{borderColor:n,borderWidth:r,backgroundColor:o,opacity:s,borderRadius:a}),this.overlayElement=document.createElement("div"),this.overlayElement.id="hygraph-preview-overlay",this.overlayElement.style.cssText=`\n      position: fixed;\n      pointer-events: none;\n      z-index: 9999;\n      border: ${r} solid ${n};\n      background: ${o};\n      border-radius: ${a};\n      display: none;\n      transition: all 0.2s ease;\n      box-sizing: border-box;\n      opacity: ${s};\n    `;const d=(null==(t=this.config.overlay)?void 0:t.button)||{},l=d.backgroundColor||"#3B82F6",h=d.color||"white",c=d.borderRadius||"6px",u=d.fontSize||"14px",g=d.padding||"8px 12px";this.editButtonElement=document.createElement("button"),this.editButtonElement.id="hygraph-preview-edit-button",this.editButtonElement.innerHTML='\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n      Edit\n    ',this.editButtonElement.style.cssText=`\n      position: fixed;\n      z-index: 10000;\n      background: ${l};\n      color: ${h};\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: ${c};\n      padding: ${g};\n      font-size: ${u};\n      font-weight: 500;\n      cursor: pointer;\n      display: none;\n      align-items: center;\n      gap: 6px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);\n      transition: all 0.2s ease;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;\n      pointer-events: auto;\n      width: 72px;\n      height: 32px;\n      justify-content: center;\n      box-sizing: border-box;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    `;const p=this.darkenColor(l,.1);this.editButtonElement.addEventListener("mouseenter",()=>{this.editButtonElement.style.background=p,this.editButtonElement.style.transform="scale(1.05)"}),this.editButtonElement.addEventListener("mouseleave",()=>{this.editButtonElement.style.background=l,this.editButtonElement.style.transform="scale(1)"}),document.body.appendChild(this.overlayElement),document.body.appendChild(this.editButtonElement)}setupEventListeners(){document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseleave",this.handleMouseLeave),document.addEventListener("scroll",this.handleScroll,!0),window.addEventListener("resize",this.handleResize)}removeEventListeners(){document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseleave",this.handleMouseLeave),document.removeEventListener("scroll",this.handleScroll,!0),window.removeEventListener("resize",this.handleResize)}isMouseOverEditButton(e){if(!this.editButtonElement)return!1;const t=this.editButtonElement.getBoundingClientRect();return e.clientX>=t.left&&e.clientX<=t.right&&e.clientY>=t.top&&e.clientY<=t.bottom}updateOverlayPosition(e){if(!this.overlayElement)return;const t=e.getBoundingClientRect();this.overlayElement.style.left=`${t.left}px`,this.overlayElement.style.top=`${t.top}px`,this.overlayElement.style.width=`${t.width}px`,this.overlayElement.style.height=`${t.height}px`}updateEditButton(e){if(!this.editButtonElement||!this.currentTarget)return;const t=this.currentTarget.getBoundingClientRect();let i=t.top+4,n=t.right-72-4;n<t.left+4&&(n=t.left+4),i+32+4>t.bottom&&(i=Math.max(t.top+4,t.bottom-32-4)),n=Math.max(t.left+4,Math.min(n,t.right-72-4)),i=Math.max(t.top+4,Math.min(i,t.bottom-32-4)),this.editButtonElement.style.left=`${n}px`,this.editButtonElement.style.top=`${i}px`,this.editButtonElement.onclick=t=>{t.preventDefault(),t.stopPropagation(),this.handleEditClick(e)};const r=e.fieldApiId||"entry";this.editButtonElement.title=`Edit ${r}`}handleEditClick(e){const t=new CustomEvent("hygraph-edit-click",{detail:e,bubbles:!0});document.dispatchEvent(t),this.config.debug&&console.log("[OverlayManager] Edit button clicked:",e)}showOverlayElements(){this.overlayElement&&(this.overlayElement.style.display="block"),this.editButtonElement&&(this.editButtonElement.style.display="flex")}hideOverlayElements(){this.overlayElement&&(this.overlayElement.style.display="none"),this.editButtonElement&&(this.editButtonElement.style.display="none")}removeOverlayElements(){this.overlayElement&&(this.overlayElement.remove(),this.overlayElement=null),this.editButtonElement&&(this.editButtonElement.remove(),this.editButtonElement=null)}darkenColor(e,t){if(e.startsWith("#")){const i=e.replace("#",""),n=parseInt(i.substr(0,2),16),r=parseInt(i.substr(2,2),16),o=parseInt(i.substr(4,2),16),s=Math.floor(n*(1-t)),a=Math.floor(r*(1-t)),d=Math.floor(o*(1-t));return`#${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}return"#3B82F6"===e?"#2563EB":e}}class o{constructor(){this.detectedFramework=null,this.detectFramework()}getFramework(){return this.detectedFramework}getRefreshFunction(){if(!this.detectedFramework)return null;switch(this.detectedFramework.type){case"nextjs":return this.getNextjsRefresh();case"remix":return this.getRemixRefresh();case"gatsby":return this.getGatsbyRefresh();case"nuxt":return this.getNuxtRefresh();case"sveltekit":return this.getSveltekitRefresh();default:return this.getVanillaRefresh()}}async refresh(){const e=this.getRefreshFunction();e?await e():window.location.reload()}detectFramework(){this.hasNextjs()?this.detectedFramework={type:"nextjs",router:this.getNextjsRouter()}:this.hasRemix()?this.detectedFramework={type:"remix",revalidator:this.getRemixRevalidator()}:this.hasGatsby()?this.detectedFramework={type:"gatsby"}:this.hasNuxt()?this.detectedFramework={type:"nuxt"}:this.hasSveltekit()?this.detectedFramework={type:"sveltekit"}:this.detectedFramework={type:"vanilla"}}hasNextjs(){return"undefined"!=typeof window&&(Boolean(window.__NEXT_DATA__)||Boolean(window.next)||null!==document.querySelector('script[src*="/_next/"]'))}hasRemix(){return"undefined"!=typeof window&&(Boolean(window.__remixContext)||Boolean(window.__remixRouterContext)||null!==document.querySelector('script[src*="/build/"]'))}hasGatsby(){return"undefined"!=typeof window&&(Boolean(window.___gatsby)||Boolean(window.__GATSBY)||null!==document.querySelector("[data-gatsby-browser-entry]"))}hasNuxt(){return"undefined"!=typeof window&&(Boolean(window.__NUXT__)||Boolean(window.$nuxt)||null!==document.querySelector("#__nuxt"))}hasSveltekit(){return"undefined"!=typeof window&&(Boolean(window.__SVELTEKIT__)||null!==document.querySelector("[data-sveltekit-preload-data]"))}getNextjsRouter(){var e,t;return"undefined"==typeof window?null:(null==(e=window.next)?void 0:e.router)??(null==(t=window.__NEXT_DATA__)?void 0:t.router)??null}getRemixRevalidator(){var e;return"undefined"==typeof window?null:window.__remixRevalidator??(null==(e=window.__remixRouterContext)?void 0:e.revalidator)??null}getNextjsRefresh(){const e=this.getNextjsRouter();if(e&&"function"==typeof e.replace){const t=e.replace.bind(e);return()=>{t(e.asPath||window.location.pathname)}}return"function"==typeof window.location.reload?()=>window.location.reload():null}getRemixRefresh(){const e=this.getRemixRevalidator();if(e&&"function"==typeof e.revalidate)return()=>e.revalidate();const t=window.__remixRevalidate;return"function"==typeof t?()=>t():null}getGatsbyRefresh(){return()=>window.location.reload()}getNuxtRefresh(){const e=window.$nuxt;if(e&&"function"==typeof e.refresh){const t=e.refresh.bind(e);return()=>t()}const t=window.refreshCookie;return"function"==typeof t?()=>t():()=>window.location.reload()}getSveltekitRefresh(){const e=window.invalidateAll;return"function"==typeof e?()=>e():()=>window.location.reload()}getVanillaRefresh(){return()=>window.location.reload()}getSetupInstructions(){if(!this.detectedFramework)return"";switch(this.detectedFramework.type){case"nextjs":return"\n// Next.js setup:\nimport { HygraphPreview } from '@hygraph/preview-sdk/react';\nimport { useRouter } from 'next/router';\n\nfunction App() {\n  const router = useRouter();\n\n  return (\n    <HygraphPreview\n      endpoint=\"your-endpoint\"\n      onSave={() => router.replace(router.asPath)}\n    >\n      {/* Your content */}\n    </HygraphPreview>\n  );\n}";case"remix":return"\n// Remix setup:\nimport { HygraphPreview } from '@hygraph/preview-sdk/react';\nimport { useRevalidator } from '@remix-run/react';\n\nexport default function App() {\n  const revalidator = useRevalidator();\n\n  return (\n    <HygraphPreview\n      endpoint=\"your-endpoint\"\n      onSave={() => revalidator.revalidate()}\n    >\n      {/* Your content */}\n    </HygraphPreview>\n  );\n}";case"vanilla":return"\n// Vanilla JS setup:\nimport { Preview } from '@hygraph/preview-sdk';\n\nconst preview = new Preview({\n  endpoint: 'your-endpoint'\n});\n\npreview.subscribe('save', {\n  callback: () => window.location.reload()\n});";default:return`\n// ${this.detectedFramework.type} setup:\nimport { Preview } from '@hygraph/preview-sdk';\n\nconst preview = new Preview({\n  endpoint: 'your-endpoint'\n});\n\npreview.subscribe('save', {\n  callback: () => {\n    // Add framework-specific refresh logic here\n    window.location.reload();\n  }\n});`}}}class s{constructor(e){this.messageBridge=null,this.saveCallbacks=new Set,this.handleEditClick=e=>{const t=e.detail.element;"iframe"===this.mode?this.handleIframeEditClick(t):this.handleStandaloneEditClick(t)},this.config={debug:!1,overlayEnabled:!0,updateDelay:50,retryAttempts:3,autoConnect:!0,allowedOrigins:["https://app.hygraph.com","http://localhost:3000"],...e},this.frameworkIntegration=new o,this.mode=this.determineMode(),this.fieldRegistry=new t(this.config),this.contentUpdater=new n(this.config),this.overlayManager=new r(this.config),"iframe"===this.mode?this.initializeIframeMode():this.initializeStandaloneMode(),this.setupEditClickHandler(),this.config.debug&&(window.__HYGRAPH_PREVIEW__=this),this.emitEvent("preview:ready",{preview:this})}subscribe(e,t){if("save"===e)return this.saveCallbacks.add(t.callback),()=>this.saveCallbacks.delete(t.callback);throw new Error(`Unknown event type: ${e}`)}getVersion(){return"2.0.0"}getMode(){return this.mode}getFrameworkIntegration(){return this.frameworkIntegration}getFieldRegistryStats(){return this.fieldRegistry.getStats()}getFieldRegistryKeys(){return this.fieldRegistry.getRegistryKeys()}isConnected(){var e;return(null==(e=this.messageBridge)?void 0:e.isConnectedToStudio())??!1}refresh(){this.fieldRegistry.refresh()}configureOverlay(e){this.config.overlay||(this.config.overlay={}),e.style&&(this.config.overlay.style={...this.config.overlay.style,...e.style}),e.button&&(this.config.overlay.button={...this.config.overlay.button,...e.button}),this.overlayManager.destroy(),this.overlayManager=new r(this.config),this.config.debug&&console.log("[Preview] Overlay configuration updated:",e)}destroy(){var e;this.fieldRegistry.destroy(),null==(e=this.messageBridge)||e.destroy(),this.contentUpdater.destroy(),this.overlayManager.destroy(),this.saveCallbacks.clear(),document.removeEventListener("hygraph-edit-click",this.handleEditClick),window.__HYGRAPH_PREVIEW__===this&&delete window.__HYGRAPH_PREVIEW__}determineMode(){if("iframe"===this.config.mode)return"iframe";if("standalone"===this.config.mode)return"standalone";try{return window.self===window.top?"standalone":"iframe"}catch(e){return"iframe"}}initializeIframeMode(){this.config.debug&&console.log("[Preview] Initializing in iframe mode"),this.messageBridge=new i({debug:this.config.debug,allowedOrigins:this.getAllowedOrigins(),onMessage:this.handleStudioMessage.bind(this),onReady:()=>{this.config.debug&&console.log("[Preview] MessageBridge ready, sending ready message to Studio"),this.config.autoConnect&&this.sendReadyMessage()}}),this.setupIframeEditHandlers()}initializeStandaloneMode(){this.config.debug&&console.log("[Preview] Initializing in standalone mode"),this.config.studioUrl||this.isProductionEndpoint()||console.warn("[Preview] Consider setting studioUrl for development endpoints"),this.setupStandaloneEditHandlers()}getAllowedOrigins(){const e=[...this.config.allowedOrigins||[]];return this.config.studioUrl&&e.push(new URL(this.config.studioUrl).origin),e}isProductionEndpoint(){return!!this.config.endpoint&&(this.config.endpoint.includes("api.hygraph.com")||this.config.endpoint.includes(".hygraph.com")||this.config.endpoint.includes(".hygraph.dev"))}scanRichTextFormatPreferences(){const e={},t={};return document.querySelectorAll("[data-hygraph-entry-id][data-hygraph-rich-text-format]").forEach(i=>{const n=i.getAttribute("data-hygraph-entry-id"),r=i.getAttribute("data-hygraph-field-api-id"),o=i.getAttribute("data-hygraph-rich-text-format"),s=i.getAttribute("data-hygraph-field-locale")||"";if(n&&r&&o&&["html","markdown","text"].includes(o)){const i=`${n}:${r}:${s}`;e[i]?(t[i]||(t[i]=[e[i]]),t[i].push(o)):e[i]=o,this.config.debug&&console.log(`[Preview] Rich Text format preference detected: ${i} -> ${o}`)}}),Object.entries(t).forEach(([e,t])=>{[...new Set(t)].length>1&&console.warn(`üö® [Preview] UNSUPPORTED USAGE: Rich Text field "${e}" appears multiple times with different formats: [${t.join(", ")}].\n\n‚ö†Ô∏è  LIMITATION: Each Rich Text field should appear only ONCE per format in your preview.\n‚úÖ SOLUTION: Use different field API IDs or choose one format.\n\nExample:\n‚ùå <div data-hygraph-field-api-id="description" data-hygraph-rich-text-format="html">\n‚ùå <div data-hygraph-field-api-id="description" data-hygraph-rich-text-format="markdown">\n\n‚úÖ <div data-hygraph-field-api-id="description" data-hygraph-rich-text-format="html">\n‚úÖ <div data-hygraph-field-api-id="descriptionMd" data-hygraph-rich-text-format="markdown">\n\nüìñ See: https://docs.claude.com/preview-sdk#rich-text-limitations`)}),e}sendReadyMessage(){var e,t;if(!this.messageBridge)return;const i={fieldFocusSync:(null==(e=this.config.sync)?void 0:e.fieldFocus)??!1,fieldUpdateSync:(null==(t=this.config.sync)?void 0:t.fieldUpdate)??!1,richTextFormatPreferences:this.scanRichTextFormatPreferences()},n={type:"ready",sdkVersion:this.getVersion(),capabilities:i,timestamp:Date.now()};this.messageBridge.sendReadyMessage(n)}handleStudioMessage(e){switch(console.log("[Preview] handleStudioMessage called with:",e.type,e),e.type){case"init":this.handleInitMessage(e);break;case"field-update":this.handleFieldUpdate(e);break;case"field-focus":console.log("[Preview] Routing to handleFieldFocus"),this.handleFieldFocus(e);break;case"content-saved":this.handleContentSaved(e);break;case"disconnect":this.handleDisconnect()}}handleInitMessage(e){this.config.debug&&console.log("[Preview] Connected to Studio:",e.studioOrigin),this.emitEvent("preview:connected",{studioOrigin:e.studioOrigin})}async handleFieldUpdate(e){this.config.onFieldUpdate?(console.log("[Preview] Using custom onFieldUpdate handler"),this.config.onFieldUpdate(e)):(console.log("[Preview] Using built-in ContentUpdater"),await this.contentUpdater.updateField(e))}handleFieldFocus(e){if(console.log("[Preview] Received field-focus message:",{entryId:e.entryId,fieldApiId:e.fieldApiId,componentChain:e.componentChain,locale:e.locale}),this.emitEvent("preview:field-focus",{entryId:e.entryId,fieldApiId:e.fieldApiId,locale:e.locale}),this.config.onFieldFocus)return console.log("[Preview] Using custom onFieldFocus handler"),void this.config.onFieldFocus(e.fieldApiId,e.locale);console.log("[Preview] Searching for field in registry...");let t=this.fieldRegistry.getElementsForEntryField(e.entryId,e.fieldApiId,void 0);if(console.log("[Preview] Initial registry search result:",{foundCount:t.length,foundElements:t.map(e=>({fieldApiId:e.fieldApiId,entryId:e.entryId,element:e.element.tagName,componentChainRaw:e.componentChainRaw}))}),e.componentChain&&e.componentChain.length>0){console.log("[Preview] Filtering by component chain:",e.componentChain);const i=JSON.stringify(e.componentChain);t=t.filter(e=>{if(!e.componentChainRaw)return console.log("[Preview] Element has no component chain, skipping"),!1;try{const t=e.componentChainRaw;return console.log("[Preview] Comparing chains:",{target:i,element:t}),t===i}catch(t){return console.log("[Preview] Error comparing chains:",t),!1}}),console.log("[Preview] After filtering by component chain:",{foundCount:t.length})}if(t.length>0){const e=t[0].element;console.log("[Preview] Scrolling to element:",e),e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("hygraph-field-highlight"),setTimeout(()=>{e.classList.remove("hygraph-field-highlight")},2e3),(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&e.focus()}else console.warn("[Preview] Could not find element for field focus:",{entryId:e.entryId,fieldApiId:e.fieldApiId,componentChain:e.componentChain,locale:e.locale}),console.log("[Preview] All registered elements:",this.fieldRegistry.getRegistryKeys())}async handleContentSaved(e){this.config.debug&&console.log("[Preview] Content saved, triggering framework refresh"),this.emitEvent("preview:content-saved",{entryId:e.entryId,timestamp:e.timestamp});for(const i of this.saveCallbacks)try{await i(e.entryId)}catch(t){console.error("[Preview] Save callback failed:",t)}}handleDisconnect(){this.config.debug&&console.log("[Preview] Disconnected from Studio"),this.emitEvent("preview:disconnected",{})}setupEditClickHandler(){document.addEventListener("hygraph-edit-click",this.handleEditClick)}setupIframeEditHandlers(){}setupStandaloneEditHandlers(){}handleIframeEditClick(e){var t;const i=e.getAttribute("data-hygraph-entry-id"),n=e.getAttribute("data-hygraph-field-api-id")||void 0,r=e.getAttribute("data-hygraph-field-locale")||void 0,o=this.parseComponentChain(e.getAttribute("data-hygraph-component-chain")||void 0);if(i){if(this.messageBridge){const s={type:"field-click",entryId:i,fieldApiId:n,locale:r,componentChain:o,timestamp:Date.now()};this.messageBridge.sendMessage(s)||!1===(null==(t=this.config.standalone)?void 0:t.fallbackToNewTab)||(this.config.debug&&console.log("[Preview] Studio not connected, falling back to new tab"),this.handleStandaloneEditClick(e))}this.emitEvent("preview:field-click",{entryId:i,fieldApiId:n,locale:r,componentChain:o,mode:this.mode})}}handleStandaloneEditClick(e){const t=e.getAttribute("data-hygraph-entry-id"),i=e.getAttribute("data-hygraph-field-api-id")||void 0,n=e.getAttribute("data-hygraph-field-locale")||void 0,r=this.parseComponentChain(e.getAttribute("data-hygraph-component-chain")||void 0);if(!t)return;if(!this.config.endpoint)return void console.error("[Preview] Cannot open Studio - no endpoint configured");const o=this.buildStudioUrl(t,i,n,r);window.open(o,"_blank","noopener,noreferrer"),this.config.debug&&console.log("[Preview] Opened Studio in new tab:",o),this.emitEvent("preview:field-click",{entryId:t,fieldApiId:i,locale:n,componentChain:r,mode:this.mode})}buildStudioUrl(e,t,i,n){const r=this.config.studioUrl||"https://app.hygraph.com",o=new URLSearchParams({endpoint:this.config.endpoint,entryId:e});return t&&o.set("fieldApiId",t),i&&o.set("locale",i),n&&n.length>0&&o.set("componentChain",JSON.stringify(n)),`${r}/entry?${o.toString()}`}parseComponentChain(e){if(e)try{const t=JSON.parse(e);if(!Array.isArray(t))return;const i=t.map(e=>{if(!e||"object"!=typeof e)return null;const{fieldApiId:t,instanceId:i}=e;return"string"==typeof t&&"string"==typeof i&&i?{fieldApiId:t,instanceId:i}:null}).filter(e=>Boolean(e));return i.length>0?i:void 0}catch(t){return void(this.config.debug&&console.warn("[Preview] Failed to parse component chain attribute",e,t))}}emitEvent(e,t){const i=new CustomEvent(e,{detail:t});document.dispatchEvent(i)}}function a(e){if(!e||0===e.length)return;const t=e.filter(e=>Boolean(e&&"string"==typeof e.fieldApiId&&"string"==typeof e.instanceId)).map(e=>({fieldApiId:e.fieldApiId,instanceId:e.instanceId}));return t.length?JSON.stringify(t):void 0}e.ContentUpdater=n,e.FieldRegistry=t,e.FrameworkIntegration=o,e.MessageBridge=i,e.OverlayManager=r,e.Preview=s,e.createComponentChainLink=function(e,t){if(!e)throw new Error("[Preview SDK] createComponentChainLink requires a fieldApiId");if(!t)throw new Error("[Preview SDK] createComponentChainLink requires an instanceId");return{fieldApiId:e,instanceId:t}},e.createPreviewAttributes=function(e){const{entryId:t,fieldApiId:i,locale:n,componentChain:r}=e;if(!t)throw new Error("[Preview SDK] createPreviewAttributes requires an entryId");const o={"data-hygraph-entry-id":t};i&&(o["data-hygraph-field-api-id"]=i),n&&(o["data-hygraph-field-locale"]=n);const s=a(r);return s&&(o["data-hygraph-component-chain"]=s),o},e.default=s,e.serializeComponentChain=a,e.withFieldPath=function(e,t){return{...e,"data-hygraph-field-path":t}},Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.umd.js.map
